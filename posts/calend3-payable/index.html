<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="hacking the markets: financial programming tutorials by parttimelarry">
    
    <link rel="shortcut icon" href="https://hackingthemarkets.github.io/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XCGL4SLHHN"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-XCGL4SLHHN', { 'anonymize_ip': false });
}
</script>


    <title>web3 tutorial [07/10] - payable: appointments and payments</title>
</head>
<body><header id="banner">
    <h2><a href="https://hackingthemarkets.github.io">hacking the markets</a></h2>
    <nav>
        <ul>
            <li>
                <a href="/" title="posts">posts</a>
            </li><li>
                <a href="https://youtube.com/parttimelarry" title="youtube">youtube</a>
            </li><li>
                <a href="https://twitter.com/parttimelarry" title="twitter">twitter</a>
            </li><li>
                <a href="https://github.com/hackingthemarkets" title="github">github</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>web3 tutorial [07/10] - payable: appointments and payments</h1>
            <div>
                <time>February 22, 2022</time>
                
                <span>
                    
                        by parttimelarry
                    
                </span></div>
    </header><br />

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/vdgciGS3F-8" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<aside id="toc">
    <h4>Table of Contents</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#appointment-data-structures">Appointment Data Structures</a>
      <ul>
        <li><a href="#strings---apointment-title">Strings - Apointment Title</a></li>
        <li><a href="#time---meeting-times">Time - Meeting Times</a></li>
        <li><a href="#integers---amount-paid">Integers - Amount Paid</a></li>
        <li><a href="#addresses---attendee">Addresses - Attendee</a></li>
        <li><a href="#structs---grouping-data-together">Structs - Grouping Data Together</a></li>
        <li><a href="#arrays---a-list-of-appointments">Arrays - A list of appointments</a></li>
      </ul>
    </li>
    <li><a href="#appointment-functions">Appointment Functions</a>
      <ul>
        <li><a href="#get-appointment-list">Get Appointment List</a></li>
        <li><a href="#adding-an-appointment">Adding an Appointment</a></li>
      </ul>
    </li>
    <li><a href="#lets-test-again-like-we-did-last-summer">Let&rsquo;s Test Again (Like We Did Last Summer)</a>
      <ul>
        <li><a href="#reusing-deployment-code-with-beforeeach">Reusing deployment code with beforeEach()</a></li>
        <li><a href="#testing-appointment-functions">Testing Appointment Functions</a></li>
      </ul>
    </li>
    <li><a href="#how-are-we-gonna-pay-for-this">How are we gonna pay for this?</a>
      <ul>
        <li><a href="#payable">Payable</a></li>
        <li><a href="#testing-ether-transfer-between-accounts">Testing Ether Transfer Between Accounts</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>

<h1 id="appointment-data-structures">Appointment Data Structures</h1>
<p>Our smart contract can now store rates, but how do we store the appointments? An appointment is a bit more complex since it isn&rsquo;t a single string or numerical field. Let&rsquo;s start by discussing each piece of data that makes up an appointment, then group them together into a more complex data type.</p>
<h2 id="strings---apointment-title">Strings - Apointment Title</h2>
<p>The first piece of data we need to store is the title of the appointment. This could be &ldquo;Larry / John 1:1&rdquo; or &ldquo;Mario Kart Livestream&rdquo;. We will represent this as a <strong>string</strong> just as we would in other programming languages.</p>
<h2 id="time---meeting-times">Time - Meeting Times</h2>
<p>Each meeting will have a startTime and an endTime. But how do we store dates and times in Solidity? There is no native datetime type in Solidity. We will use a <a href="https://en.wikipedia.org/wiki/Unix_time">unix timestamp</a>, which is the number of second since Unix Epoch (00:00:00 UTC on 1 January 1970). Since this number is a positive integer, we will use a <strong>uint</strong> for both startTime and endTime.</p>
<h2 id="integers---amount-paid">Integers - Amount Paid</h2>
<p>In Calend3, meetings are not free to schedule. Time is money. So to book an appointment, you gotta pay. But how much? We want to allow rates that are less than 1 ETH, but don&rsquo;t want to deal with decimals. So we will store our money values in <strong>wei</strong> - the smallest denomination of Ether. There are 1,000,000,000,000,000,000 (10^18) wei in 1 Ether. Solidity lets you write <strong>0.1 ether</strong> for simplicity and stores it as 100000000000000000 for you.</p>
<h2 id="addresses---attendee">Addresses - Attendee</h2>
<p>Who are we meeting? We will store the Ethereum address of the person scheduling the appointment. For the purpose of this tutorial, the person scheduling the appointment is the attendee and meetings will be 1:1.</p>
<h2 id="structs---grouping-data-together">Structs - Grouping Data Together</h2>
<p>Notice how all of these appointment fields are grouped together for a single appointment. How do we keep them all together? There&rsquo;s a data type for that! It&rsquo;s called a <strong>struct</strong>. This data type will already be familiar to you if you are a C programmer. A struct lets you create a user-defined complex data type that is a grouping of multiple variables.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kd">struct</span> <span class="nc">Appointment</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="n">title</span><span class="p">;</span>     <span class="c1">// title of the meeting
</span><span class="c1"></span>    <span class="kt">address</span> <span class="n">attendee</span><span class="p">;</span> <span class="c1">// person you are meeting
</span><span class="c1"></span>    <span class="kt">uint</span> <span class="n">startTime</span><span class="p">;</span>   <span class="c1">// start time of meeting
</span><span class="c1"></span>    <span class="kt">uint</span> <span class="n">endTime</span><span class="p">;</span>     <span class="c1">// end time of the meeting
</span><span class="c1"></span>    <span class="kt">uint</span> <span class="n">amountPaid</span><span class="p">;</span>  <span class="c1">// amount paid for the meeting
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><h2 id="arrays---a-list-of-appointments">Arrays - A list of appointments</h2>
<p>But wait. There&rsquo;s more. We&rsquo;re not just going to have one appoinment. We want a fully booked calendar with many appointments so we can rake in $ETH all day. Since we will be storing many appointments, we will use an <strong>appointments</strong> <em><strong>array</strong></em> to store a list of <strong>Appointment</strong> <em><strong>structs</strong></em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="n">Appointment</span><span class="p">[]</span> <span class="n">appointments</span><span class="p">;</span>
</code></pre></div><p>Putting it all together, our smart contract now looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="c1">// SPDX-License-Identifier: MIT
</span><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="nc">Calend3</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">rate</span><span class="p">;</span>
    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>

    <span class="kd">struct</span> <span class="nc">Appointment</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="n">title</span><span class="p">;</span>     <span class="c1">// title of the meeting
</span><span class="c1"></span>        <span class="kt">address</span> <span class="n">attendee</span><span class="p">;</span> <span class="c1">// person you are meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">startTime</span><span class="p">;</span>   <span class="c1">// start time of meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">endTime</span><span class="p">;</span>     <span class="c1">// end time of the meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">amountPaid</span><span class="p">;</span>  <span class="c1">// amount paid for the meeting
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="n">Appointment</span><span class="p">[]</span> <span class="n">appointments</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">getRate</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>   
    
    <span class="kd">function</span> <span class="nf">setRate</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_rate</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">,</span> <span class="s">&#34;Only the owner can set the rate&#34;</span><span class="p">);</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">_rate</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h1 id="appointment-functions">Appointment Functions</h1>
<h2 id="get-appointment-list">Get Appointment List</h2>
<p>Now that we have the data structures in place to store our appointments, we need functions for creating and retrieving them. Let&rsquo;s start with the function for getting the appointment list:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kd">function</span> <span class="nf">getAppointments</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Appointment</span><span class="p">[]</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">appointments</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>We defined a public function called getAppointments(). It returns the appointments that are stored on the blockchain. We specified Appointment[] as the return data type. Note that Solidity now requires &ldquo;memory&rdquo; to be specified here or you will get a compilation error. The <em><strong>memory</strong></em> keyword specifies a temporary place to store data.</p>
<h2 id="adding-an-appointment">Adding an Appointment</h2>
<p>Next we need to write a function to create an appointment. This function should have inputs for each appointment field that is entered by the user. These include the title, startTime, and endTime. In the body of the function, we create a new Appointment and set each element of the struct to the corresponding input.</p>
<p>We don&rsquo;t need to provide an input for the attendee address since the address will just be the <strong>msg.sender</strong> (the person that called the function). To calculate the amount paid, we first calculate the number of minutes by subtracting the meeting startTime from the endTime (in seconds) and dividing by that number by 60 (the number of seconds in a minute). Then we just multiply the number of minutes by the rate that was set by the calendar owner.</p>
<p>Once we have our Appointment struct filled with data, we use the push() function to append it to the <strong>appointments</strong> array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kd">function</span> <span class="nf">createAppointment</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">title</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">startTime</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">endTime</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
    <span class="n">Appointment</span> <span class="k">memory</span> <span class="n">appointment</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">startTime</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">endTime</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">amountPaid</span> <span class="o">=</span> <span class="p">((</span><span class="n">endTme</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span> 
    <span class="n">appointment</span><span class="p">.</span><span class="n">attendee</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span> <span class="c1">// address of person calling contract
</span><span class="c1"></span>
    <span class="n">appointments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">appointment</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Putting it all together, your smart contract should now look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="c1">// SPDX-License-Identifier: MIT
</span><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="nc">Calend3</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">rate</span><span class="p">;</span>
    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>

    <span class="kd">struct</span> <span class="nc">Appointment</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="n">title</span><span class="p">;</span>     <span class="c1">// title of the meeting
</span><span class="c1"></span>        <span class="kt">address</span> <span class="n">attendee</span><span class="p">;</span> <span class="c1">// person you are meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">startTime</span><span class="p">;</span>   <span class="c1">// start time of meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">endTime</span><span class="p">;</span>     <span class="c1">// end time of the meeting
</span><span class="c1"></span>        <span class="kt">uint</span> <span class="n">amountPaid</span><span class="p">;</span>  <span class="c1">// amount paid for the meeting
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="n">Appointment</span><span class="p">[]</span> <span class="n">appointments</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">getRate</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>   
    
    <span class="kd">function</span> <span class="nf">setRate</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_rate</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">,</span> <span class="s">&#34;Only the owner can set the rate&#34;</span><span class="p">);</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">_rate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">getAppointments</span><span class="p">()</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Appointment</span><span class="p">[]</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">appointments</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">createAppointment</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">title</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">startTime</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">endTime</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="n">Appointment</span> <span class="k">memory</span> <span class="n">appointment</span><span class="p">;</span>
        <span class="n">appointment</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
        <span class="n">appointment</span><span class="p">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">startTime</span><span class="p">;</span>
        <span class="n">appointment</span><span class="p">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">endTime</span><span class="p">;</span>
        <span class="n">appointment</span><span class="p">.</span><span class="n">amountPaid</span> <span class="o">=</span> <span class="p">((</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span> 
        <span class="n">appointment</span><span class="p">.</span><span class="n">attendee</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span> <span class="c1">// address of person calling contract
</span><span class="c1"></span>
        <span class="n">appointments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">appointment</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h1 id="lets-test-again-like-we-did-last-summer">Let&rsquo;s Test Again (Like We Did Last Summer)</h1>
<p>Now that we&rsquo;ve added data types and functions for managing appointments, we should probably run some tests to make sure it works. Let&rsquo;s write a test to add a couple of appointments and retrieve them from storage.</p>
<h2 id="reusing-deployment-code-with-beforeeach">Reusing deployment code with beforeEach()</h2>
<p>We will be creating many standalone tests that each require the same logic for contract deployment. Rather than repeating these lines of code for each test, we can use befortEach() to run the same block of code before each test.  Let&rsquo;s refactor our test.js to look like the code snippet below. Notice how we can separate our permission test and give it its own description.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="n">const</span> <span class="p">{</span> <span class="n">expect</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s">&#34;chai&#34;</span><span class="p">);</span>
<span class="n">const</span> <span class="p">{</span> <span class="n">ethers</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s">&#34;hardhat&#34;</span><span class="p">);</span>

<span class="n">describe</span><span class="p">(</span><span class="s">&#34;Calend3&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">let</span> <span class="n">Contract</span><span class="p">,</span> <span class="kd">contract</span><span class="p">;</span>
  <span class="kr">let</span> <span class="n">owner</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">;</span>

  <span class="c1">// `beforeEach` will run before each test
</span><span class="c1"></span>  <span class="n">beforeEach</span><span class="p">(</span><span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">owner</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ethers</span><span class="p">.</span><span class="n">getSigners</span><span class="p">();</span>

    <span class="n">Contract</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ethers</span><span class="p">.</span><span class="n">getContractFactory</span><span class="p">(</span><span class="s">&#34;Calend3&#34;</span><span class="p">);</span>
    <span class="kd">contract</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Contract</span><span class="p">.</span><span class="n">deploy</span><span class="p">();</span>
    <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">deployed</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="n">it</span><span class="p">(</span><span class="s">&#34;Should set rate&#34;</span><span class="p">,</span> <span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">const</span> <span class="nb">tx</span> <span class="o">=</span> <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">setRate</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

    <span class="c1">// wait until the transaction is mined
</span><span class="c1"></span>    <span class="n">await</span> <span class="nb">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

    <span class="c1">// verify rate is set correctly
</span><span class="c1"></span>    <span class="n">expect</span><span class="p">(</span><span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">getRate</span><span class="p">()).</span><span class="n">to</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="n">it</span><span class="p">(</span><span class="s">&#34;Should fail if non-owner rate&#34;</span><span class="p">,</span> <span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// call setRate using a different account address
</span><span class="c1"></span>    <span class="c1">// this should fail since this address is not the owner
</span><span class="c1"></span>    <span class="n">await</span> <span class="n">expect</span><span class="p">(</span>
      <span class="kd">contract</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr1</span><span class="p">).</span><span class="n">setRate</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
      <span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">be</span><span class="p">.</span><span class="n">revertedWith</span><span class="p">(</span><span class="s">&#39;Only the owner can set the rate&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div><h2 id="testing-appointment-functions">Testing Appointment Functions</h2>
<p>Now that we have done this refactoring, let&rsquo;s write a test that creates a couple of appointments. We will call contract.createAppointment() twice with different inputs, then call contract.getAppointments() and verify that two appointments are returned.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="n">const</span> <span class="p">{</span> <span class="n">expect</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s">&#34;chai&#34;</span><span class="p">);</span>
<span class="n">const</span> <span class="p">{</span> <span class="n">ethers</span> <span class="p">}</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s">&#34;hardhat&#34;</span><span class="p">);</span>

<span class="n">describe</span><span class="p">(</span><span class="s">&#34;Calend3&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">let</span> <span class="n">Contract</span><span class="p">,</span> <span class="kd">contract</span><span class="p">;</span>
  <span class="kr">let</span> <span class="n">owner</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">;</span>

  <span class="c1">// `beforeEach` will run before each test
</span><span class="c1"></span>  <span class="n">beforeEach</span><span class="p">(</span><span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">owner</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ethers</span><span class="p">.</span><span class="n">getSigners</span><span class="p">();</span>

    <span class="n">Contract</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ethers</span><span class="p">.</span><span class="n">getContractFactory</span><span class="p">(</span><span class="s">&#34;Calend3&#34;</span><span class="p">);</span>
    <span class="kd">contract</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Contract</span><span class="p">.</span><span class="n">deploy</span><span class="p">();</span>
    <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">deployed</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="n">it</span><span class="p">(</span><span class="s">&#34;Should set rate&#34;</span><span class="p">,</span> <span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">const</span> <span class="nb">tx</span> <span class="o">=</span> <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">setRate</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

    <span class="c1">// wait until the transaction is mined
</span><span class="c1"></span>    <span class="n">await</span> <span class="nb">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

    <span class="c1">// verify rate is set correctly
</span><span class="c1"></span>    <span class="n">expect</span><span class="p">(</span><span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">getRate</span><span class="p">()).</span><span class="n">to</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="n">it</span><span class="p">(</span><span class="s">&#34;Should fail if non-owner rate&#34;</span><span class="p">,</span> <span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// call setRate using a different account address
</span><span class="c1"></span>    <span class="c1">// this should fail since this address is not the owner
</span><span class="c1"></span>    <span class="n">await</span> <span class="n">expect</span><span class="p">(</span>
      <span class="kd">contract</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr1</span><span class="p">).</span><span class="n">setRate</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
      <span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">be</span><span class="p">.</span><span class="n">revertedWith</span><span class="p">(</span><span class="s">&#39;Only the owner can set the rate&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="n">it</span><span class="p">(</span><span class="s">&#34;Should add two appointments&#34;</span><span class="p">,</span> <span class="n">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">const</span> <span class="nb">tx</span> <span class="o">=</span> <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">createAppointment</span><span class="p">(</span><span class="s">&#34;Meeting with Part Time Larry&#34;</span><span class="p">,</span> <span class="mi">1644143400</span><span class="p">,</span> <span class="mi">1644150600</span><span class="p">);</span>
    <span class="n">await</span> <span class="nb">tx</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

    <span class="n">const</span> <span class="n">tx2</span> <span class="o">=</span> <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">createAppointment</span><span class="p">(</span><span class="s">&#34;Breakfast at Tiffany&#39;s&#34;</span><span class="p">,</span> <span class="mi">1644154200</span><span class="p">,</span> <span class="mi">1644159600</span><span class="p">);</span>
    <span class="n">await</span> <span class="n">tx2</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

    <span class="n">const</span> <span class="n">appointments</span> <span class="o">=</span> <span class="n">await</span> <span class="kd">contract</span><span class="p">.</span><span class="n">getAppointments</span><span class="p">();</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">appointments</span><span class="p">.</span><span class="n">length</span><span class="p">).</span><span class="n">to</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div><h1 id="how-are-we-gonna-pay-for-this">How are we gonna pay for this?</h1>
<p>So we stored a rate and an amountPaid, but no money actually exchanged hands. How do we add payments? One of the nice things about web3 applications it that we have payment functionality built-in already, we just need to use it. We don&rsquo;t need to apply for an API key, make requests to a 3rd party, or ask for anyone&rsquo;s personal information.</p>
<p>The user simply connects their wallet to our dapp. When they execute our smart contract, we prompt them with the cost of the transaction. They sign or reject the transaction. If they approve, then they are charged Eth. In return, they get their thing. Going back to the vending machine analogy, they input some meeting details and some Ether, and in return they got a meeting on our calendar.</p>
<h2 id="payable">Payable</h2>
<p>To actually send the Ether, first we must make the contract owner address <strong>payable</strong>. This means that the address can accept ether. Then, in the constructor, we cast the msg.sender to address payable.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kt">address</span> <span class="k">payable</span> <span class="n">owner</span><span class="p">;</span>

<span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="k">payable</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span> <span class="c1">// contract creator can be paid
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>We must make the <strong>createAppointment()</strong> function <strong>payable</strong>. When the client/user calls createAppointment, they will need to send a message (msg) with a <strong>value</strong>. This value is a number and represents an amount of ether. Let&rsquo;s update createAppointment() to look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kd">function</span> <span class="nf">createAppointment</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">title</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">startTime</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">endTime</span><span class="p">)</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
    <span class="n">Appointment</span> <span class="k">memory</span> <span class="n">appointment</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">startTime</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">endTime</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">amountPaid</span> <span class="o">=</span> <span class="p">((</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span><span class="p">;</span>
    <span class="n">appointment</span><span class="p">.</span><span class="n">attendee</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span> <span class="c1">// address of person calling contract
</span><span class="c1"></span>
    <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">appointment</span><span class="p">.</span><span class="n">amountPaid</span><span class="p">,</span> <span class="s">&#34;We require more ether&#34;</span><span class="p">);</span> <span class="c1">// validate the amount of ETH
</span><span class="c1"></span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span> <span class="c1">// send ETH to the owner
</span><span class="c1"></span>    <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Failed to send Ether&#34;</span><span class="p">);</span>

    <span class="n">appointments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">appointment</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Notice that we require() msg.value to be greater than the amount paid. If the user tries call this contract with an amount of Ether that is too low for the length of the appointment, then we will fail with the error message &ldquo;We require more ether&rdquo;.</p>
<p>If they send the correct amount, we can go ahead and send the ether value to the owner of the contract using owner.call{}. We will use an additional require() to make sure this was successful. If not, we will roll back the transaction.</p>
<p>If all succeeded, than we can proceed and add the appointment to our Appointment[] array and store it on the blockchain. We could add some additional error checking to this function, but I think this is a good stopping point to do some testing.</p>
<h2 id="testing-ether-transfer-between-accounts">Testing Ether Transfer Between Accounts</h2>
<p>Now that our payment logic is in place and being enforced, let&rsquo;s update our createAppointment() test in <strong>test.js</strong> to make sure we can successfully send ether.</p>
<p>Also, remember how hardhat gives us 20 test accounts? Let&rsquo;s have multiple users create appointments. We&rsquo;ll use connect() to call createAppointment() from different test accounts.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">it</span><span class="p">(</span><span class="s2">&#34;Should add two appointments&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">tx1</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setRate</span><span class="p">(</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;0.001&#34;</span><span class="p">));</span>
  <span class="kr">await</span> <span class="nx">tx1</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
  
  <span class="kr">const</span> <span class="nx">tx2</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">addr1</span><span class="p">).</span><span class="nx">createAppointment</span><span class="p">(</span><span class="s2">&#34;Meeting with Part Time Larry&#34;</span><span class="p">,</span> <span class="mi">1644143400</span><span class="p">,</span> <span class="mi">1644150600</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">)});</span>
  <span class="kr">await</span> <span class="nx">tx2</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">tx3</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">addr2</span><span class="p">).</span><span class="nx">createAppointment</span><span class="p">(</span><span class="s2">&#34;Breakfast at Tiffany&#39;s&#34;</span><span class="p">,</span> <span class="mi">1644154200</span><span class="p">,</span> <span class="mi">1644159600</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;1.5&#34;</span><span class="p">)});</span>
  <span class="kr">await</span> <span class="nx">tx3</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">appointments</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">getAppointments</span><span class="p">();</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">appointments</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>Let&rsquo;s also make sure that the <strong>ether balances</strong> for <strong>addr1</strong> and <strong>addr2</strong> go down when they pay for an appointment, and that the ether balance of the contract <strong>owner</strong> goes up!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript">  <span class="nx">it</span><span class="p">(</span><span class="s2">&#34;Should add two appointments&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">tx1</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setRate</span><span class="p">(</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;0.001&#34;</span><span class="p">));</span>
    <span class="kr">await</span> <span class="nx">tx1</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

    <span class="kr">const</span> <span class="nx">tx2</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">addr1</span><span class="p">).</span><span class="nx">createAppointment</span><span class="p">(</span><span class="s2">&#34;Meeting with Part Time Larry&#34;</span><span class="p">,</span> <span class="mi">1644143400</span><span class="p">,</span> <span class="mi">1644150600</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;2&#34;</span><span class="p">)});</span>
    <span class="kr">await</span> <span class="nx">tx2</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

    <span class="kr">const</span> <span class="nx">tx3</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">addr2</span><span class="p">).</span><span class="nx">createAppointment</span><span class="p">(</span><span class="s2">&#34;Breakfast at Tiffany&#39;s&#34;</span><span class="p">,</span> <span class="mi">1644154200</span><span class="p">,</span> <span class="mi">1644159600</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">parseEther</span><span class="p">(</span><span class="s2">&#34;1.5&#34;</span><span class="p">)});</span>
    <span class="kr">await</span> <span class="nx">tx3</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>

    <span class="kr">const</span> <span class="nx">appointments</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">getAppointments</span><span class="p">();</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">appointments</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">ownerBalance</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBalance</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">addr1Balance</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBalance</span><span class="p">(</span><span class="nx">addr1</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">addr2Balance</span><span class="o">=</span> <span class="kr">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">getBalance</span><span class="p">(</span><span class="nx">addr2</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ownerBalance</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">addr1Balance</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">addr2Balance</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div><p>If all goes well, you should see output like the following when you run <em>npx hardhat test</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">npx hardhat <span class="nb">test</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">  calend3
     Should <span class="nb">set</span> the minutely rate
     Should fail <span class="k">if</span> non-owner sets rate
BigNumber <span class="o">{</span> value: <span class="s2">&#34;10003495662956532660632&#34;</span> <span class="o">}</span>
BigNumber <span class="o">{</span> value: <span class="s2">&#34;9997999749063762602628&#34;</span> <span class="o">}</span>
BigNumber <span class="o">{</span> value: <span class="s2">&#34;9998499818227205344040&#34;</span> <span class="o">}</span>
</code></pre></div><p>Looking pretty good so far. Feel free to write more tests to verify the account values and test any edge cases. I&rsquo;m going to continue on to other topics so that I can finish writing this tutorial :). In the next section, we will create the UI for scheduling appointments using a Material UI calendar component.</p>
</article>

        </main><footer id="footer">
    copyright  2022 parttimelarry
</footer>
</body>
</html>
